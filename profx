## Alix Feinsod
## Process of igmfn, for execution on profx comp
## Created April 22nd, 2015
## runs MCMC and emails results

from bottle import route, run, template, post, request
import smtplib, os
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email.utils import COMMASPACE, formatdate
from email import encoders
from array import array
from email.mime.application import MIMEApplication

from xastropy.igm.fN import mcmc 
from xastropy.igm.fN import data as fNdata
from xastropy.xutils import xdebug as xdb

from bottle import static_file

def do_response():

  ##Get variables somehow from server
  ##+file upload if necessary
		
		if modelType is 'Akio Model':
			mcmc.mcmc_main(useremail, sources, extraSources, 1)
			#fN_model = mcmc.set_fn_model(1) 
		else:
			mcmc.mcmc_main(useremail, sources, extraSources)
		
		msg = MIMEMultipart()
		msg['Subject'] = "Email data"
		msg['From'] = 'xastropy@aol.com'
		msg['To'] = useremail
		msg.attach( MIMEText(str('Hi!')))
	##TODO: change this part to generating Dropbox folder with files in it and emailing the link
		files = os.listdir('C:/Xastropy Output Files/' + useremail)
	
		for f in files:
        		part = MIMEBase('application', "octet-stream")
        		part.set_payload( open('C:/Xastropy Output Files/' + useremail + '/' + f,"rb").read() )
        		encoders.encode_base64(part)
        		part.add_header('Content-Disposition', 'attachment; filename="{0}"'.format(os.path.basename(f)))
        		msg.attach(part)
   	
   		smtp = smtplib.SMTP()
   		smtp.connect('smtp.aol.com', 587)
   		smtp.ehlo()
   		smtp.starttls()
   		smtp.ehlo()
   		smtp.login('xastropy@aol.com','ucsc2015')
    		smtp.sendmail('xastropy@aol.com', useremail, msg.as_string())
    		smtp.quit()
    	
		return "Processing your request. Results will be sent to '{0}' in a few hours or days.".format(useremail)

run(host='0.0.0.0', port=8080)
